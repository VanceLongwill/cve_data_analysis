import pandas as pd
import matplotlib.pyplot as plt
import matplotlib.ticker as mtick
import numpy as np


def top_vulns(df: pd.DataFrame):
    top10 = df['CWE-NAME'].value_counts(normalize=True).head(10)
    return top10


def vulnerability_types_by_year(df: pd.DataFrame):
    top10 = top_vulns(df)
    top_10_keys = top10.keys()

    freqs_by_year = pd.crosstab(
        index=df['Year'], columns=df['CWE-NAME'], margins=True)

    # frequencies of each vuln by year
    freqs_by_year.rename(
        index={'All': 'coltotal'},
        columns={'All': 'rowtotal'},
        inplace=True)

    # relative frequencies of each vuln by year
    rel_freqs_by_year = freqs_by_year.div(freqs_by_year['rowtotal'], axis=0)

    rel_freqs_by_year = rel_freqs_by_year.drop(
        columns=['rowtotal'], index=['coltotal'])


    top_10_rel_freq_over_time = rel_freqs_by_year[top_10_keys]

    top_10_rel_freq_over_time.plot(kind='line')
    plt.show()




# print(rel_freqs_by_year.idxmax(axis=1))

# print(rel_freqs_by_year.groupby('Year').apply(
#     lambda x: -np.sort(-np.ravel(x))[:3]))
# print(rel_freqs_by_year)

# print(rel_freqs_by_year.columns)
# print(rel_freqs_by_year.tail(10))
