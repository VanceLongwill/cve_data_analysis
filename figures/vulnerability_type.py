import pandas as pd
import matplotlib.pyplot as plt
import matplotlib.ticker as mtick

def top_vulns(df: pd.DataFrame):
    top10 = df['CWE-NAME'].value_counts(normalize=True).head(10)
    return top10


def vulnerability_types_by_year(df: pd.DataFrame):
    # get a list of the top 10 most frequently reported vulnerability types overall
    top10 = top_vulns(df)
    top_10_keys = top10.keys()

    # frequencies of each vuln by year
    freqs_by_year = pd.crosstab(
        index=df['Year'], columns=df['CWE-NAME'], margins=True)

    # prepare for relative frequency calculation by renaming columns
    freqs_by_year.rename(
        index={'All': 'coltotal'},
        columns={'All': 'rowtotal'},
        inplace=True)

    # relative frequencies of each vuln by year
    rel_freqs_by_year = freqs_by_year.div(freqs_by_year['rowtotal'], axis=0)

    # remove the totals columns
    rel_freqs_by_year = rel_freqs_by_year.drop(
        columns=['rowtotal'], index=['coltotal'])

    # select the relative frequencies of only the top 10 most frequent of all time
    top_10_rel_freq_over_time = rel_freqs_by_year[top_10_keys]

    pl = top_10_rel_freq_over_time.plot(
        kind='line',
        ylim=(0, 1),
        ylabel='Relative frequency (percentage)',
        xlabel='Year',
        title='Relative frequencies of the overall top 10 vulnerability types'
    )

    # format decimal as percentage
    pl.yaxis.set_major_formatter(mtick.PercentFormatter(1.0))

    plt.show()
